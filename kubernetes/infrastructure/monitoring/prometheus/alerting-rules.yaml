---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerting-rules
  namespace: monitoring
data:
  alerting-rules.yml: |
    groups:
      - name: node-alerts
        rules:
          - alert: HighDiskUsage
            expr: |
              (1 - node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) * 100 > 85
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High disk usage on {{ $labels.instance }}"
              description: "Disk usage on {{ $labels.mountpoint }} is above 85% (current: {{ printf \"%.1f\" $value }}%)."

          - alert: DiskSpaceCritical
            expr: |
              (1 - node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) * 100 > 95
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Critical disk usage on {{ $labels.instance }}"
              description: "Disk usage on {{ $labels.mountpoint }} is above 95% (current: {{ printf \"%.1f\" $value }}%). Immediate action required."

          - alert: HighMemoryUsage
            expr: |
              (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 > 80
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage on {{ $labels.instance }}"
              description: "Node memory usage is above 80% (current: {{ printf \"%.1f\" $value }}%)."

          - alert: HighCPUUsage
            expr: |
              100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage on {{ $labels.instance }}"
              description: "Node CPU usage is above 90% for 5 minutes (current: {{ printf \"%.1f\" $value }}%)."

      - name: pod-alerts
        rules:
          - alert: PodCrashLooping
            expr: |
              increase(kube_pod_container_status_restarts_total[10m]) > 3
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
              description: "Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} has restarted {{ printf \"%.0f\" $value }} times in the last 10 minutes."

          - alert: PodNotReady
            expr: |
              kube_pod_status_ready{condition="true"} == 0
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready"
              description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} has been in a non-ready state for more than 5 minutes."

      - name: media-stack-alerts
        rules:
          - alert: VPNDown
            expr: |
              absent(kube_pod_status_ready{pod=~"gluetun-transmission.*", condition="true"} == 1)
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "VPN pod (gluetun-transmission) is not running"
              description: "The gluetun-transmission pod is not running or not ready. All VPN-dependent traffic (Transmission, FlareSolverr) is affected."

          - alert: DownloadClientDown
            expr: |
              absent(kube_pod_status_ready{pod=~"gluetun-transmission.*", condition="true"} == 1)
              or
              absent(kube_pod_status_ready{pod=~"sabnzbd.*", condition="true"} == 1)
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Download client is unreachable"
              description: "One or more download clients (Transmission or SABnzbd) are not running or unreachable for more than 5 minutes."
