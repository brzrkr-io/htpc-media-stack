---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: monitoring
data:
  config.alloy: |
    // Grafana Alloy - Kubernetes log collector
    // Direct filesystem-based log collection (no K8s API dependency)

    // Match all pod log files on the node
    local.file_match "pod_logs" {
      path_targets = [{
        __path__ = "/var/log/pods/*/*/*.log",
      }]
    }

    // Tail matched log files
    loki.source.file "pod_logs" {
      targets    = local.file_match.pod_logs.targets
      forward_to = [loki.process.pod_logs.receiver]
    }

    // Parse CRI format and extract labels from file path
    loki.process "pod_logs" {
      // Parse CRI log format
      stage.cri {}

      // Extract namespace, pod, container from file path
      // Path format: /var/log/pods/<namespace>_<pod>_<uid>/<container>/<N>.log
      stage.regex {
        source     = "filename"
        expression = "/var/log/pods/(?P<namespace>[^_]+)_(?P<pod>[^_]+)_[^/]+/(?P<container>[^/]+)/.*\\.log"
      }

      stage.labels {
        values = {
          namespace = "",
          pod       = "",
          container = "",
        }
      }

      forward_to = [loki.write.default.receiver]
    }

    // Send logs to Loki
    loki.write "default" {
      endpoint {
        url = "http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push"
      }
    }
