---
# CrowdSec - Collaborative security engine
# Detects and blocks malicious behavior using crowd-sourced intelligence
# Works with Traefik bouncer to block bad actors at the ingress level
apiVersion: apps/v1
kind: Deployment
metadata:
  name: crowdsec
  namespace: security
  labels:
    app: crowdsec
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: crowdsec
  template:
    metadata:
      labels:
        app: crowdsec
    spec:
      serviceAccountName: crowdsec
      containers:
        - name: crowdsec
          image: crowdsecurity/crowdsec:latest
          env:
            - name: TZ
              value: "America/New_York"
            - name: GID
              value: "1000"
            # Install collections for common attack detection
            - name: COLLECTIONS
              value: "crowdsecurity/traefik crowdsecurity/http-cve crowdsecurity/whitelist-good-actors crowdsecurity/linux"
            # Enroll key can be added later from app.crowdsec.net
            # - name: ENROLL_KEY
            #   value: ""
          ports:
            - containerPort: 8080
              name: api
              protocol: TCP
            - containerPort: 6060
              name: metrics
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /etc/crowdsec
            - name: data
              mountPath: /var/lib/crowdsec/data
            - name: acquis-config
              mountPath: /etc/crowdsec/acquis.d
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 10

      volumes:
        - name: config
          hostPath:
            path: /data/media/config/crowdsec/config
            type: DirectoryOrCreate
        - name: data
          hostPath:
            path: /data/media/config/crowdsec/data
            type: DirectoryOrCreate
        - name: acquis-config
          configMap:
            name: crowdsec-acquis
