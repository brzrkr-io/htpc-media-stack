---
# NetworkPolicy for the media namespace
#
# NOTE: k3s v1.33+ uses kube-router's network policy controller alongside
# flannel, which actively enforces NetworkPolicies. These rules are live.
#
# Allowed traffic:
#   Ingress:
#     - From within media namespace (Prowlarr syncing indexers to Sonarr/Radarr, etc.)
#     - From kube-system namespace (traefik ingress controller)
#     - From monitoring namespace (exportarr scraping metrics)
#     - From downloads namespace (download client callbacks)
#     - From LAN (Jellyfin NodePort for Apple TV, etc.)
#   Egress:
#     - Within media namespace (Radarr->Prowlarr, Sonarr->Prowlarr, etc.)
#     - To downloads namespace (sending grabs to download clients)
#     - To DNS (kube-dns in kube-system)
#     - To internet (metadata lookups, indexer queries, subtitle downloads)

# Default deny all ingress and egress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: media
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
# Allow ingress within media namespace (Prowlarr->Sonarr/Radarr sync, etc.)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-intra-namespace
  namespace: media
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector: {}
---
# Allow ingress from kube-system (Traefik ingress)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-from-traefik
  namespace: media
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
---
# Allow ingress from monitoring namespace (exportarr -> arr apps for metrics)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-from-monitoring
  namespace: media
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
---
# Allow ingress from downloads namespace (download client callbacks)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-from-downloads
  namespace: media
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: downloads
---
# Allow ingress from LAN (Jellyfin NodePort access from Apple TV, etc.)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-from-lan
  namespace: media
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - ipBlock:
            cidr: 192.168.1.0/24
---
# Allow egress within media namespace (Radarr->Prowlarr, Sonarr->Prowlarr, etc.)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-egress-intra-namespace
  namespace: media
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector: {}
---
# Allow egress to downloads namespace (Sonarr/Radarr -> SABnzbd/Transmission)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-egress-to-downloads
  namespace: media
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: downloads
---
# Allow egress to DNS (kube-dns in kube-system)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-egress-dns
  namespace: media
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
---
# Allow egress to internet (metadata lookups, indexer queries, etc.)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-egress-internet
  namespace: media
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.42.0.0/16  # k3s pod CIDR
              - 10.43.0.0/16  # k3s service CIDR
